
#include <Firebase_Arduino_WiFiNINA.h>
#include <Adafruit_DotStar.h>
#include <Arduino_LSM6DS3.h> 
#include <DHT.h> 
#include <Servo.h>       

// Firebase 
#define FIREBASE_HOST "arduino-wi-fi-xmas-tree-db-default-rtdb.europe-west1.firebasedatabase.app"
#define FIREBASE_AUTH "WCkUg3iFB4NRbBHg2IXc0bsosgHo5kM5bXmUvZie"
#define WIFI_SSID "iPhone van Cesar"
#define WIFI_PASSWORD "not so safe 123"

// DotStar ledstrip
#define NUMPIXELS 300
#define DATAPIN    4
#define CLOCKPIN   8

// temperature sensor
#define DHTPIN 7   
#define DHTTYPE DHT11

String treeId = "/Rudolph-A3EpYEF7zU";
String jsonStr;
String previousMessage;
String mode = "idle";

int pirInputPin = 2;               
int pirState = LOW;    
int pirVal = 0;  
int count = 0;

bool attackedByCat = false;

float previousHum;    
float previousTemp;   

int alfabed[][90]= {
/* A */ {242, 241, 224, 225, 226, 227, 228, 202, 203, 240, 243, 223, 221, 222, 207, 208, 209, 210, 211, 179, 180, 181, 165, 166, 167, 131, 132, 133, 134, 164, 163, 135, 136, 162, 161, 160, 159, 158, 157, 156, 190, 200, 201, 204, 188, 189, 141, 142, 140, 139, 138, 137, 106, 104, 105, 85, 86, 113, 114, 115, 75, 76, 77, 53, 54, 55, 84, 46, 45, 44}, 
/* B */ {246, 220, 221, 245, 244, 243, 223, 222, 224, 242, 241, 225, 226, 227, 240, 239, 238, 237, 228, 229, 230, 231, 199, 200, 201, 189, 190, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 181, 209, 210, 180, 182, 208, 183, 184, 185, 186, 187, 188, 143, 142, 141, 105, 104, 103, 87, 86, 85, 45, 84, 46, 83, 47, 48, 82, 166, 132, 133, 134, 112, 113, 114, 76, 77, 78, 79, 80, 81, 49, 50, 51, 52, 53, 54},
/* C */ {238, 239, 227, 228, 229, 230, 200, 201, 202, 240, 241, 242, 243, 244, 222, 223, 224, 225, 226, 221, 220, 219, 211, 210, 209, 181, 180, 179, 167, 166, 165, 133, 132, 131, 115, 114, 113, 77, 76, 75, 78, 79, 80, 81, 82, 83, 84, 85, 86, 104, 105, 106, 46, 47, 48, 49, 50, 51, 52, 53},
/* D */ {246, 245, 244, 243, 242, 241, 240, 239, 238, 228, 229, 227, 226, 225, 224, 223, 222, 221, 220, 210, 209, 208, 182, 181, 180, 166, 165, 164, 134, 133, 132, 114, 113, 112, 78, 77, 76, 54, 53, 52, 51, 79, 80, 81, 82, 49, 50, 48, 47, 83, 46, 84, 85, 86, 230, 231, 199, 200, 201, 189, 190, 191, 155, 156, 157, 141, 142, 143, 103, 104, 105}, 
/* E */ {236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 211, 210, 209, 179, 180, 181, 167, 166, 165, 164, 163, 162, 161, 160, 159, 131, 132, 133, 115, 114, 113, 75, 76, 77, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44, 78, 79, 80, 81, 82, 83, 84, 85, 86, 182, 183, 184, 185, 186, 187, 188, 158}, 
/* F*/ {247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 236, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 211, 210, 209, 179, 180, 181, 182, 183, 184, 185, 186, 187, 167, 166, 165, 164, 163, 162, 161, 160, 159, 131, 132, 133, 115, 114, 113, 75, 76, 77, 55, 54, 53}, 
/* G */ {245, 244, 243, 242, 241, 240, 239, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 203, 202, 201, 179, 180, 181, 167, 166, 165, 162, 161, 160, 159, 158, 157, 131, 132, 133, 136, 137, 138, 139, 140, 141, 115, 114, 113, 107, 106, 105, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 53, 52, 51, 50, 49, 48, 47},
/* H */ {247, 246, 245, 238, 237, 236, 219, 220, 221, 228, 229, 230, 211, 210, 209, 202, 201, 200, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 140, 141, 142, 106, 105, 104, 84, 85, 86, 46, 45, 44, 131, 132, 133, 115, 114, 113, 75, 76, 77, 55, 54, 53}, 
/* I */ {247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 236, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 206, 205, 204, 184, 185, 186, 162, 161, 160, 136, 137, 138, 110, 109, 108, 80, 81, 82, 54, 53, 52, 75, 55, 76, 77, 78, 79, 51, 50, 49, 48, 83, 84, 85, 86, 47, 46, 45, 44}, 
/* J */ {239, 238, 237, 227, 228, 229, 203, 202, 201, 187, 188, 189, 159, 158, 157, 139, 140, 141, 107, 106, 105, 83, 130, 131, 132, 116, 115, 114, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 53, 52, 51, 50, 49, 48}, 
/* K */ {246, 245, 244, 238, 237, 236, 220, 221, 222, 226, 227, 228, 229, 210, 209, 208, 206, 205, 204, 203, 180, 181, 182, 183, 184, 185, 166, 165, 164, 163, 162, 132, 133, 134, 135, 136, 137, 114, 113, 112, 110, 109, 108, 107,76,  77, 78, 82, 83, 84, 85, 46, 45, 44, 54, 53, 52}, 
/* L */ {246, 245, 244, 220, 221, 222, 210, 209, 208, 180, 181, 182, 166, 165, 164, 132, 133, 134, 114, 113, 112, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44},
/* M */ {247, 246, 245, 238, 237, 236, 219, 220, 221, 222, 223, 226, 227, 228, 229, 230, 211, 210, 209, 208, 207, 206, 205, 204, 203, 202, 201, 200, 179, 180, 181, 184, 185, 188, 189, 190, 167, 166, 165, 131, 132, 133, 115, 114, 113, 75, 76, 77, 55, 54, 53, 158, 157, 156, 140, 141, 142, 106, 105, 104, 84, 85, 86, 46, 45, 44},
/* N */ {246, 245, 244, 238, 237, 236, 220, 221, 222, 223, 228, 229, 230, 210, 209, 208, 207, 206, 202, 201, 200, 180, 181, 182, 183, 184, 185, 188, 189, 190, 166, 165, 164, 162, 161, 160, 158, 157, 156, 132, 133, 134, 137, 138, 139, 140, 141, 142, 114, 113, 112, 108, 107, 106, 105, 104, 83, 84, 85, 86, 76, 77, 78, 54, 53, 52, 46, 45, 44},
/* O */ {245, 244, 243, 242, 241, 240, 239, 238, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 179, 180, 181, 167, 166, 165, 131, 132, 133, 115, 114, 113, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 202, 201, 200, 188, 189, 190, 158, 157, 156, 140, 141, 142, 106, 105, 104, 53, 52, 51, 50, 49, 48, 47},
/* P */ {246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 210, 209, 208, 201, 200, 199, 189, 180, 181, 182, 190, 191, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 114, 113, 112, 76, 77, 78, 54, 53, 52},
/* Q */ {245, 244, 243, 242, 241, 240, 239, 238, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 179, 180, 181, 202, 201, 200, 188, 189, 190, 158, 157, 156, 167, 166, 165, 131, 132, 133, 140, 141, 142, 115, 114, 113, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 106, 105, 104, 53, 52, 51, 50, 49, 48, 47, 46, 45, 86, 44, 107, 108, 109, 110, 137, 136},
/* R */ {246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 210, 209, 208, 201, 200, 199, 180, 181, 182, 189, 190, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 132, 133, 134, 137, 138, 139, 114, 113, 112, 107, 106, 105, 76, 77, 78, 85, 86, 87, 54, 53, 52, 45, 44, 43},
/* S */ {245, 244, 243, 242, 241, 240, 239, 238, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 180, 181, 202, 201, 200, 188, 189, 190, 182, 183, 184, 185, 164, 163, 162, 161, 160, 159, 138, 139, 140, 141, 106, 105, 104, 84, 85, 86, 131, 132, 133, 115, 114, 113, 76, 77, 78, 79, 80, 81, 82, 83, 53, 52, 51, 50, 49, 48, 47, 46},
/* T */ {247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 236, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 207, 206, 205, 204, 183, 184, 185, 186, 163, 162, 161, 160, 135, 136, 137, 138, 111, 110, 109, 108, 79, 80, 81, 82, 51, 50, 49, 48},
/* U */ {247, 246, 245, 219, 220, 221, 211, 210, 209, 179, 180, 181, 167, 166, 165, 131, 132, 133, 115, 114, 113, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 52, 51, 50, 49, 48, 47, 46, 112, 238, 237, 236, 228, 229, 230, 202, 201, 200, 188, 189, 190, 158, 157, 156, 140, 141, 142, 106, 105, 104, 107},
/* V */ {247, 246, 245, 238, 237, 236, 219, 220, 221, 228, 229, 230, 211, 210, 209, 202, 201, 200, 179, 180, 181, 167, 166, 165, 188, 189, 190, 158, 157, 156, 131, 132, 133, 140, 141, 142, 114, 113, 112, 111, 108, 107, 106, 105, 77, 78, 79, 80, 81, 82, 83, 84, 51, 50, 49, 48},
/* W */ {247, 246, 245, 219, 220, 221, 238, 237, 236, 228, 229, 230, 211, 210, 209, 202, 201, 200, 179, 180, 181, 188, 189, 190, 167, 166, 165, 158, 157, 156, 131, 132, 133, 140, 141, 142, 136, 137, 115, 114, 113, 112, 111, 110, 109, 108, 107, 106, 105, 104, 75, 76, 77, 78, 83, 84, 85, 86, 55, 54, 53, 46, 45, 44},
/* X */ {247, 246, 245, 238, 237, 236, 219, 220, 221, 228, 229, 230, 210, 209, 208, 207, 204, 203, 202, 201, 182, 183, 184, 185, 186, 187, 164, 163, 162, 161, 160, 159, 132, 133, 134, 135, 138, 139, 140, 141, 115, 114, 113, 75, 76, 77, 55, 54, 53, 106, 105, 104, 84, 85, 86, 46, 45, 44},
/* Y */ {247, 246, 245, 238, 237, 236, 219, 220, 221, 228, 229, 230, 211, 210, 209, 202, 201, 200, 180, 181, 182, 187, 188, 189, 165, 164, 163, 162, 161, 160, 159, 158, 136, 137, 110, 109, 80, 81, 50, 49, 135, 138, 111, 108, 79, 82, 51, 48, 183, 186},
/* Z */ {247, 246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 236, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 204, 203, 202, 184, 185, 186, 164, 163, 162, 133, 134, 135, 114, 113, 112, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44},
};

int numbers[][90]= {
 /* 0 */ {244, 243, 242, 241, 240, 239, 221, 222, 223, 224, 225, 226, 227, 228, 211, 210, 209, 202, 201, 200, 179, 180, 181, 188, 189, 190, 167, 166, 165, 158, 157, 156, 131, 132, 133, 140, 141, 142, 115, 114, 113, 106, 105, 104, 77, 78, 79, 80, 81, 82, 83, 84, 52, 51, 50, 49, 48, 47, 184, 185, 162, 161, 136, 137}, 
 /* 1 */ {241, 240, 239, 223, 224, 225, 226, 227, 209, 208, 207, 206, 205, 204, 203, 179, 180, 181, 182, 185, 186, 187, 167, 166, 165, 161, 160, 159, 137, 138, 139, 109, 108, 107, 81, 82, 83, 49, 48, 47},
 /* 2 */ {244, 243, 242, 241, 240, 239, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 202, 201, 200, 188, 189, 187, 179, 180, 181, 162, 161, 160, 159, 135, 136, 137, 138, 113, 112, 111, 110, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45},
 /* 3 */ {244, 243, 242, 241, 240, 239, 238, 221, 222, 223, 224, 225, 226, 227, 228, 229, 202, 201, 200, 210, 209, 208, 188, 189, 184, 185, 186, 187, 162, 161, 160, 159, 158, 157, 140, 141, 142, 106, 105, 104, 114, 113, 112, 77, 78, 79, 80, 81, 82, 83, 84, 85, 52, 51, 50, 49, 48, 47},
 /* 4 */ {240, 239, 238, 226, 227, 228, 224, 225, 208, 207, 206, 204, 203, 202, 180, 181, 182, 186, 187, 188, 168, 167, 166, 160, 159, 158, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 108, 107, 106, 82, 83, 84, 48, 47, 46},
 /* 5 */ {246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 210, 209, 208, 180, 181, 182, 183, 184, 185, 186, 187, 188, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 139, 140, 141, 107, 106, 105, 76, 77, 78, 79, 80, 81, 82, 83, 84, 53, 52, 51, 50, 49, 48, 47},
 /* 6 */ {238, 244, 243, 242, 241, 240, 239, 221, 222, 223, 224, 225, 226, 227, 228, 229, 210, 209, 208, 202, 201, 200, 180, 181, 182, 183, 184, 185, 186, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 140, 141, 142, 132, 133, 134, 114, 113, 112, 77, 78, 79, 80, 81, 82, 83, 84, 85, 106, 105, 104, 52, 51, 50, 49, 48, 47, 46},
 /* 7 */ {246, 245, 244, 243, 242, 241, 240, 239, 238, 237, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 203, 202, 201, 186, 187, 188, 161, 160, 159, 136, 137, 138, 111, 110, 109, 79, 80, 81, 51, 50},
 /* 8 */ {244, 243, 242, 241, 240, 239, 221, 222, 220, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 202, 201, 200, 180, 181, 188, 189, 159, 160, 161, 162, 163, 164, 133, 132, 140, 141, 106, 105, 104, 115, 114, 113, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 52, 51, 50, 49, 48, 47},
 /* 9 */ {244, 243, 242, 241, 240, 239, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 211, 210, 209, 203, 202, 201, 179, 180, 181, 187, 188, 189, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 139, 140, 141, 107, 106, 105, 83, 84, 115, 114, 75, 76, 77, 78, 79, 80, 81, 82, 53, 52, 51, 50, 49, 48}
 };

 int specialChars[][50]= {
 /* ? */ {244, 243, 242, 241, 240, 239, 221, 222, 223, 226, 227, 228, 210, 209, 208, 203, 202, 201, 187, 188, 189, 160, 159, 161, 136, 137, 138, 80, 81, 82, 50, 49, 48, 224, 225}, 
 /* ! */ {242, 241, 240, 243, 223, 224, 225, 226, 207, 206, 205, 204, 183, 184, 185, 186, 163, 162, 161, 160, 135, 136, 137, 138, 51, 50, 49, 48, 79, 80, 81, 82},
 /* - */ {166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141}
 };

int heartAnimation[][90] = {
  {12, 13, 20, 21},
  {9, 55, 54, 53, 10, 11, 12, 13, 14, 52, 15, 18, 19, 20, 21, 22, 23, 24, 47, 46, 45, 44},
  {57, 75, 9, 76, 56, 10, 55, 77, 78, 54, 53, 52, 51, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 48, 47, 46, 45, 44, 43, 42, 83, 84, 85, 86},
  {115, 114, 113, 112, 73, 74, 75, 76, 77, 78, 79, 82, 83, 84, 85, 86, 87, 88, 107, 106, 105, 104, 57, 56, 55, 10, 11, 54, 12, 53, 13, 52, 14, 51, 15, 50, 16, 49, 17, 48, 18, 47, 19, 46, 20, 45, 21, 44, 22, 43, 42, 23},
  {131, 132, 133, 134, 111, 117, 116, 115, 114, 113, 112, 139, 140, 141, 142, 108, 107, 106, 105, 104, 103, 102, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 56, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44, 43, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21},
  {167, 166, 165, 164, 159, 158, 157, 129, 130, 131, 132, 133, 134, 135, 138, 139, 140, 141, 142, 156, 143, 144, 117, 116, 115, 114, 113, 112, 111, 110, 109, 108, 107, 106, 105, 104, 103, 102, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 12, 13, 14, 15, 16, 17, 18, 19},
  {179, 180, 181, 182, 187, 188, 189, 190, 169, 168, 167, 166, 165, 164, 163, 160, 159, 158, 157, 156, 155, 154, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 116, 115, 114, 113, 112, 111, 110, 109, 108, 107, 106, 105, 104, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 54, 53, 52, 51, 50, 49, 48, 47, 13, 14, 15, 16, 17},
  {208, 211, 210, 209, 203, 202, 201, 200, 177, 178, 179, 180, 181, 182, 183, 186, 187, 188, 189, 190, 191, 192, 169, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 154, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 115, 114, 113, 112, 111, 110, 109, 108, 107, 106, 105, 77, 78, 79, 80, 81, 82, 83, 51, 50, 49, 48, 104, 84, 16, 17},
  {219, 220, 221, 222, 227, 228, 229, 230, 213, 212, 211, 210, 209, 208, 207, 204, 203, 202, 201, 200, 199, 198, 192, 191, 190, 189, 188, 187, 186, 185, 184, 183, 182, 181, 180, 179, 178, 177, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 142, 141, 140, 138, 139, 131, 132, 133, 134, 135, 136, 137, 113, 112, 111, 110, 109, 108, 107, 78, 79, 80, 81, 51, 50},
  {219, 220, 221, 222, 227, 228, 229, 230, 213, 212, 211, 210, 209, 208, 207, 204, 203, 202, 201, 200, 199, 198, 192, 191, 190, 189, 188, 187, 186, 185, 184, 183, 182, 181, 180, 179, 178, 177, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 142, 141, 140, 138, 139, 131, 132, 133, 134, 135, 136, 137, 113, 112, 111, 110, 109, 108, 107, 78, 79, 80, 81, 51, 50},
  {219, 220, 221, 222, 227, 228, 229, 230, 213, 212, 211, 210, 209, 208, 207, 204, 203, 202, 201, 200, 199, 198, 192, 191, 190, 189, 188, 187, 186, 185, 184, 183, 182, 181, 180, 179, 178, 177, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 142, 141, 140, 138, 139, 131, 132, 133, 134, 135, 136, 137, 113, 112, 111, 110, 109, 108, 107, 78, 79, 80, 81, 51, 50},
  {220, 221, 222, 212, 211, 210, 209, 208, 207, 178, 179, 180, 181, 182, 167, 166, 165, 164, 163, 162, 183, 132, 133, 134, 112, 111, 109, 79, 80, 81, 82, 49, 50, 110, 108, 135, 136, 137, 138, 139, 140, 141, 107, 161, 160, 159, 158, 157, 156, 185, 184, 186, 187, 188, 189, 190, 191, 199, 204, 203, 202, 201, 200, 229, 228},
  {221, 222, 211, 179, 166, 133, 112, 79, 50, 49, 82, 81, 80, 111, 110, 109, 108, 107, 140, 139, 138, 137, 136, 135, 134, 165, 164, 163, 162, 161, 160, 159, 158, 157, 190, 189, 188, 182, 183, 184, 185, 186, 187, 181, 180, 210, 209, 208, 207, 206, 205, 204, 203, 202, 201, 200, 228, 227},
  {222, 223, 226, 227, 189, 158, 139, 108, 81, 80, 111, 110, 109, 138, 137, 136, 135, 134, 165, 164, 163, 162, 160, 161, 159, 188, 187, 186, 185, 184, 183, 182, 181, 180, 209, 208, 207, 206, 205, 204, 203, 202},
  {223, 208, 182, 164, 111, 80, 81, 108, 139, 138, 134, 135, 109, 110, 136, 137, 159, 160, 161, 162, 163, 183, 184, 185, 186, 187, 203, 205, 206, 207, 226, 188, 181, 204},
  {223, 224, 207, 183, 163, 110, 135, 80, 81, 138, 160, 186, 204, 226, 225, 205, 206, 184, 185, 161, 162, 136, 137, 109},
  {224, 225, 205, 206, 184, 185, 161, 162, 136, 137, 109, 110, 80, 81},
  {224, 225, 205, 206, 184, 185, 161, 162, 136, 137, 109, 110, 80, 81},
  {223, 224, 207, 183, 163, 110, 135, 80, 81, 138, 160, 186, 204, 226, 225, 205, 206, 184, 185, 161, 162, 136, 137, 109},
  {223, 208, 182, 164, 111, 80, 81, 108, 139, 138, 134, 135, 109, 110, 136, 137, 159, 160, 161, 162, 163, 183, 184, 185, 186, 187, 203, 205, 206, 207, 226, 188, 181, 204},
  {222, 223, 226, 227, 189, 158, 139, 108, 81, 80, 111, 110, 109, 138, 137, 136, 135, 134, 165, 164, 163, 162, 160, 161, 159, 188, 187, 186, 185, 184, 183, 182, 181, 180, 209, 208, 207, 206, 205, 204, 203, 202},
  {221, 222, 211, 179, 166, 133, 112, 79, 50, 49, 82, 81, 80, 111, 110, 109, 108, 107, 140, 139, 138, 137, 136, 135, 134, 165, 164, 163, 162, 161, 160, 159, 158, 157, 190, 189, 188, 182, 183, 184, 185, 186, 187, 181, 180, 210, 209, 208, 207, 206, 205, 204, 203, 202, 201, 200, 228, 227},
  {220, 221, 222, 212, 211, 210, 209, 208, 207, 178, 179, 180, 181, 182, 167, 166, 165, 164, 163, 162, 183, 132, 133, 134, 112, 111, 109, 79, 80, 81, 82, 49, 50, 110, 108, 135, 136, 137, 138, 139, 140, 141, 107, 161, 160, 159, 158, 157, 156, 185, 184, 186, 187, 188, 189, 190, 191, 199, 204, 203, 202, 201, 200, 229, 228},
  {219, 220, 221, 222, 227, 228, 229, 230, 213, 212, 211, 210, 209, 208, 207, 204, 203, 202, 201, 200, 199, 198, 192, 191, 190, 189, 188, 187, 186, 185, 184, 183, 182, 181, 180, 179, 178, 177, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 142, 141, 140, 138, 139, 131, 132, 133, 134, 135, 136, 137, 113, 112, 111, 110, 109, 108, 107, 78, 79, 80, 81, 51, 50},
  {219, 220, 221, 222, 227, 228, 229, 230, 213, 212, 211, 210, 209, 208, 207, 204, 203, 202, 201, 200, 199, 198, 192, 191, 190, 189, 188, 187, 186, 185, 184, 183, 182, 181, 180, 179, 178, 177, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 142, 141, 140, 138, 139, 131, 132, 133, 134, 135, 136, 137, 113, 112, 111, 110, 109, 108, 107, 78, 79, 80, 81, 51, 50},
  {219, 220, 221, 222, 227, 228, 229, 230, 213, 212, 211, 210, 209, 208, 207, 204, 203, 202, 201, 200, 199, 198, 192, 191, 190, 189, 188, 187, 186, 185, 184, 183, 182, 181, 180, 179, 178, 177, 168, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 156, 155, 142, 141, 140, 138, 139, 131, 132, 133, 134, 135, 136, 137, 113, 112, 111, 110, 109, 108, 107, 78, 79, 80, 81, 51, 50},
  {239, 238, 237, 236, 232, 231, 230, 229, 228, 227, 226, 223, 222, 221, 244, 245, 246, 247, 217, 218, 219, 220, 213, 212, 211, 210, 209, 208, 207, 206, 205, 204, 203, 202, 201, 200, 199, 198, 191, 190, 189, 188, 187, 186, 185, 184, 181, 182, 183, 178, 179, 180, 167, 166, 165, 164, 163, 162, 161, 160, 159, 158, 157, 133, 134, 135, 136, 137, 138, 139, 112, 111, 110, 109, 79, 80},
  {262, 261, 260, 259, 254, 253, 252, 251, 249, 248, 247, 246, 245, 244, 243, 240, 239, 238, 237, 236, 235, 234, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 212, 211, 210, 209, 208, 207, 206, 205, 204, 203, 202, 201, 200, 199, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 165, 164, 163, 162, 161, 160, 159, 138, 137, 136, 135, 110, 109},
  {275, 274, 273, 272, 267, 266, 265, 264, 250, 251, 252, 253, 254, 255, 258, 259, 260, 261, 262, 263, 237, 238, 239, 240, 241, 249, 248, 247, 246, 245, 244, 243, 242, 236, 235, 234, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 200, 201, 202, 203, 204, 207, 210, 211, 209, 208, 206, 205, 181, 182, 183, 184, 185, 186, 187, 188, 163, 162, 161, 160, 136, 137},
  {278, 277, 276, 283, 284, 285, 264, 265, 266, 267, 268, 271, 272, 273, 274, 275, 250, 251, 252, 255, 256, 257, 258, 259, 260, 254, 253, 262, 263, 261, 244, 245, 249, 248, 247, 243, 242, 241, 240, 239, 238, 237, 236, 235, 234, 246, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 207, 206, 205, 204, 203, 209, 208, 161, 162, 186, 185, 184, 183, 202},
  {293, 292, 287, 286, 285, 284, 283, 282, 279, 278, 277, 276, 275, 274, 273, 272, 271, 270, 269, 268, 267, 266, 265, 264, 263, 262, 261, 260, 259, 258, 257, 256, 255, 254, 253, 252, 251, 250, 247, 246, 245, 240, 239, 238, 237, 236, 222, 223, 224, 225, 226, 228, 207, 206, 205, 204, 185, 227, 244, 243, 242, 184, 221, 241},
  {299, 294, 293, 292, 291, 288, 287, 286, 285, 284, 283, 282, 281, 280, 279, 278, 277, 276, 275, 274, 273, 272, 271, 270, 269, 268, 267, 266, 265, 264, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 238, 239, 240, 241, 242, 243, 244, 223, 206, 205, 224, 225, 226, 245},
  {294, 295, 298, 299, 293, 292, 291, 290, 289, 288, 287, 286, 276, 277, 278, 279, 280, 281, 282, 285, 284, 283, 275, 274, 273, 272, 271, 270, 269, 268, 267, 266, 265, 264, 253, 254, 255, 256, 257, 258, 259, 260, 243, 242, 241, 240, 224, 225},
  {242, 241, 258, 257, 256, 255, 273, 272, 271, 270, 269, 268, 267, 266, 285, 284, 283, 282, 281, 280, 279, 278, 277, 276, 293, 292, 291, 290, 289, 288, 287, 286, 299, 298, 297, 296, 295, 294},
  {256, 257, 268, 269, 270, 271, 277, 278, 279, 280, 281, 282, 283, 284, 286, 287, 288, 289, 290, 293, 292, 291, 294, 295, 296, 297, 298, 299},
  {283, 270, 269, 282, 281, 280, 279, 278, 293, 292, 291, 290, 289, 288, 287, 286, 299, 298, 297, 296, 295, 294},
  {281, 280, 291, 290, 289, 288, 299, 298, 297, 294, 296, 295},
  {290, 289, 298, 297, 296, 295},
  {297, 296}
};

int wifiAnimation[][90] = {
{48, 49, 50, 51, 81, 16, 17, 18, 47, 82, 79, 52, 80, 15},
{48, 49, 50, 51, 81, 16, 17, 18, 47, 82, 79, 52, 80, 15, 140, 139, 134, 114, 115, 116, 130, 131, 133, 132, 166, 165, 163, 162, 161, 160, 159, 184, 185, 158, 157, 141, 103, 105, 143, 142, 186, 183, 164, 104},
{48, 49, 50, 51, 81, 16, 17, 18, 47, 82, 79, 52, 80, 15, 140, 139, 134, 114, 115, 116, 130, 131, 133, 132, 166, 165, 163, 162, 161, 160, 159, 184, 185, 158, 157, 141, 103, 105, 143, 142, 186, 183, 164, 104, 174, 171, 177, 176, 175, 214, 213, 227, 226, 223, 218, 222, 220, 219, 221, 212, 211, 210, 224, 225, 201, 200, 192, 198, 197, 193, 195, 194, 152, 199, 231, 228, 229, 230, 243, 242, 241, 240, 239, 244}
};


FirebaseData firebaseData;
FirebaseData stream;
DHT dht(DHTPIN, DHTTYPE);
Adafruit_DotStar strip(NUMPIXELS, DATAPIN, CLOCKPIN, DOTSTAR_BGR);
Servo servo1; 
 
void setup() {

  Serial.begin(9600);
  delay(1000);

  // init led strip
  
  //strip.begin(); // Initialize pins for output
  //strip.show();  // Turn all LEDs off ASAP

  //showLedPatternFullGreen();
  
  Serial.print("Connecting to WiFi…");
// wifi connecting...
  int status = WL_IDLE_STATUS;

  // holds everything until Wifi is connected
  while (status != WL_CONNECTED) {
    status = WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
    Serial.print(".");
    delay(300);
  }

  // wifi is connected
  Serial.print(" IP: ");
  Serial.println(WiFi.localIP());
  Serial.println();
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH, WIFI_SSID, WIFI_PASSWORD);
  Firebase.reconnectWiFi(true);


  // subscribe on message mode (simular to onvalue change)
  if (Firebase.beginStream(stream, treeId + "/mode/" )){
   Serial.println("suscribed on mode");
 }

 
  if (Firebase.getString(firebaseData, treeId + "/message/")) { 
    previousMessage = firebaseData.stringData();
  }

  // init gyro for cat attack detector
  while (!Serial);

  if (!IMU.begin()) {
    Serial.println("Failed to initialize IMU!");

    while (1);
  }


  // init temperature
  dht.begin();
  previousTemp= dht.readTemperature();
  previousHum = dht.readHumidity();  
  Firebase.setFloat(firebaseData, treeId  + "/roomTemp/", previousTemp); 
  Firebase.setFloat(firebaseData, treeId  + "/roomHumidity/", previousHum);

  //PIR sensor
   pinMode(pirInputPin, INPUT); 

   //servo 
    servo1.attach(11);
 
}
 
void loop() {

 if (!Firebase.readStream(stream)){Serial.println("Can't read stream, "+ stream.errorReason());}
 //if (stream.streamTimeout()){Serial.println("Stream timed out, resuming..."); }

  if (stream.streamAvailable())
  {
    count++;
    if (stream.dataType() == "null")
      count = 0;
    mode = stream.stringData();
    Serial.println(mode);
  }

  if (mode == "message"){
     listeningForMessages();
  }


  if (mode == "drawing" || mode =="live-drawing"){
     showDrawing();
  }


   if (mode == "motion"){
     mapMotionInLeds();
  }

  if (mode == "ball-shake"){
     handleBallShakeAnimation();
  }


// only works in idle mode to save computational power for other tasks. 
  if (mode == "idle"){
     //showLedPatternFullGreen();
      detectCatAttack();
      detectIntruder();
      getTemperature();
  }

}

void detectIntruder (){
    pirVal = digitalRead(pirInputPin);  
  if (pirVal == HIGH) {            
    if (pirState == LOW) {
      Firebase.setBool(firebaseData, treeId  + "/intruderDetection/detected/", true);
      pirState = HIGH;
    }
  } else {
    if (pirState == HIGH){
      pirState = LOW;
    }
  }
  
}

void getTemperature (){

    if (previousTemp != dht.readTemperature()){
    Firebase.setFloat(firebaseData, treeId  + "/roomTemp/", dht.readTemperature());
  }

  if (previousHum != dht.readHumidity()){
    Firebase.setFloat(firebaseData, treeId  + "/roomHumidity/", dht.readHumidity());
  }   

  previousHum = dht.readHumidity();  
  previousTemp= dht.readTemperature(); 
}

void detectCatAttack(){
   float x, y, z;
  if (IMU.gyroscopeAvailable()) {
    IMU.readGyroscope(x, y, z);
    
    if (abs(x) > 30 || abs(y) > 30 || abs(z) > 30){

      //if change in tilt is detected, send to db
      attackedByCat = true;
      Firebase.setBool(firebaseData, treeId + "/catAttackDetection/detected/", attackedByCat);
      Firebase.setTimestamp(firebaseData, treeId + "/catAttackDetection/time/");

      // for now, reset it after 5s
      delay(5000);
      attackedByCat = false;
    } else {
      attackedByCat = false;
    }
  }
}

// shows drawing in leds
void showDrawing(){

      if (Firebase.getString(firebaseData, treeId + "/drawing/litLightsOnlyColor/")) { 
          String str2 = {firebaseData.stringData()};
          Serial.println(str2);
       
          if (Firebase.getString(firebaseData, treeId + "/drawing/litLightsOnlyIndex/")) { 
                String str1 = {firebaseData.stringData()};
                Serial.println(str1);
           }
     }

    if(mode == "drawing"){
      delay(3000);
      Firebase.setString(firebaseData, treeId  + "/mode/", "idle");
    } 
}

void mapMotionInLeds(){
  String strs[20];
  int StringCount = 0;

     delay(50);
     if (Firebase.getString(firebaseData, treeId + "/motion/litLightsOnlyIndex/")) { 
          String str = {firebaseData.stringData()};


         while (str.length() > 0){
          int index = str.indexOf(' ');
          if (index == -1) {
              strs[StringCount++] = str;
              break;
          }else{
              strs[StringCount++] = str.substring(0, index);
              str = str.substring(index+1);
            }
          }
     }  
      delay(50);

        for (int i = 0; i < StringCount; i++){
          Serial.println(strs[i]);
         }
      
}

 // when new message is detected
void listeningForMessages(){
   if (Firebase.getString(firebaseData, treeId + "/message/")) { 
      if (previousMessage != firebaseData.stringData()) {
        playRingtoneServo();
        mapMessageInLeds(firebaseData.stringData());
      }
    previousMessage = firebaseData.stringData();
  }
 delay(1000);

 //set mode back to idle
  Firebase.setString(firebaseData, treeId  + "/mode/", "idle");
 }

 
  // string message to led array
 void mapMessageInLeds(String message){


  //led uit zetten 
  //strip.clear();
  
  Serial.println(message);
  message.toUpperCase();
  int messageLenght = message.length() + 1;
  char messageArray[messageLenght];
  
  message.toCharArray(messageArray, messageLenght);

  for (int i=0; i<messageLenght-1; i++) {
      //search for ASCII number and substract it with 65
      int index = int(messageArray[i]);
      Serial.println(index);
      Serial.print("These leds needs to be on for ");
      Serial.print(messageArray[i]);
      Serial.print(": ");

      if ((index >=65) && (index<= 90)) {
        
      //loop over alfabed
      
        for (int j =0; j < 90; j++) {
          if (alfabed[index- 65][j] != 0 && alfabed[index- 65][j] > 0 && alfabed[index- 65][j] < 300 ){
          //strip.setPixelColor(alfabed[index- 65][j], 0x00FF00);
          Serial.print(alfabed[index- 65][j]);
          Serial.print("-");
          } 
        }
        
      } else if (index == 63){
       
         //loop over special chars (?!-)
         for (int j =0; j < 50; j++) {
          if (specialChars[0][j] != 0 && specialChars[0][j] > 0 && specialChars[0][j] < 300 ){
          //strip.setPixelColor(specialChars[0][j], 0x00FF00);
          Serial.print(specialChars[0][j]);
          Serial.print("-");
          } 
        }
        
        
      }  else if (index == 33){
       
         //loop over special chars (?!-)
         for (int j =0; j < 50; j++) {
          if (specialChars[1][j] != 0 && specialChars[1][j] > 0 && specialChars[1][j] < 300 ){
          //strip.setPixelColor(specialChars[1][j], 0x00FF00);
          Serial.print(specialChars[1][j]);
          Serial.print("-");
          } 
        }
        
        
      }else if (index == 45 || index == 32){
       
         //loop over special chars (?!-)
         for (int j =0; j < 50; j++) {
          if (specialChars[2][j] != 0 && specialChars[2][j] > 0 && specialChars[2][j] < 300 ){
          //strip.setPixelColor(specialChars[2][j], 0x00FF00);
          Serial.print(specialChars[2][j]);
          Serial.print("-");
          } 
        }
        
      }else if ((index >=48) && (index<= 57)){
        
             //loop over number

         for (int j =0; j < 90; j++) {
          if (numbers[index- 48][j] != 0 && numbers[index- 48][j] > 0 && numbers[index- 48][j] < 300 ){
          //strip.setPixelColor(numbers[index- 48][j], 0x00FF00);
          Serial.print(numbers[index- 48][j]);
          Serial.print("-");
         } 
        
      }

      }
      
      //strip.show(); 
      Serial.println();
      delay(500);
      //strip.clear();
  }
 }

 void playRingtoneServo () {
    servo1.write(10);
    delay(1000);
    servo1.write(170);
    delay(1000);
    servo1.write(10);
 }

 void handleBallShakeAnimation() {
  for (int i =0; i < 35; i++){
     for (int j =0; j < 90; j++){
          Serial.print(heartAnimation[i][j]);
          Serial.print("-");
      }
  }
 }

 void showLedPatternFullGreen () {
  delay(100);
  strip.clear();
  delay(100);
  strip.fill(0x00FF00, 0, 300);
  strip.setBrightness(40);
  strip.show();
 }



 
